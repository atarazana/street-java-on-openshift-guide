<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploy a new version :: Street Java on OpenShift</title>
    <link rel="canonical" href="https://atarazana.github.io/street-java-on-openshift-guide/street-java-on-openshift-guide/05-deploy-a-new-version.html">
    <link rel="prev" href="04-limit-what.html">
    <link rel="next" href="06-deploy-cicd-pipelines-with-gitops.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://atarazana.github.io/street-java-on-openshift-guide">Street Java on OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="street-java-on-openshift-guide" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Street Java on OpenShift</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#openshift">Setup OpenShift 4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#download-tutorial">Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-prepare-cluster.html">2. Prepare Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#deploying-core-components">Deploying core components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#high-level-tests">High Level Tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#checking-quay">Checking Quay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-deploy-the-app.html">3. Deploy The App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-deploy-the-app.html#checking-helm-cli">Checking helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-deploy-the-app.html#installing-street-java">Installing Street Java</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-limit-what.html">4. Limit What?</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#checking-deployments">Checking Deployments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#limits">Limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#limitrange-anatomy">LimitRange Anatomy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#getting-rid-of-the-limirange">Getting Rid of the LimitRange</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#checking-the-app">Checking the App</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-deploy-a-new-version.html">5. Deploy New Version</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#anatomy-of-your-chart">Anatomy of your Chart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploying-gramola">Deploying Gramola</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploying-gramola-additional">Deploying Gramola++</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#argocd-ui-filtering">ArgoCD UI Filtering</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html">6. Deploy CICD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html#create-root-account-in-quay">Create Quay Robot Acc.</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html#deploying-cicd-pipelines">Deploying CICD Pipelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html#create-git-secret">Create Git Secret</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html#create-registry-secret">Create Registry Secret</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploy-cicd-pipelines-with-gitops.html#grant-pull-permissions">Granting Pull Permissions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-checking-cicd-pipelines.html">7. Checking CICD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-checking-cicd-pipelines.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-checking-cicd-pipelines.html#tekton-triggers">Tekton Triggers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-create-pipeline-webhooks.html">8. Create Pipelines Webhooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-create-pipeline-webhooks.html#pipeline-webhooks">Pipelines Webhooks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-create-pipeline-webhooks.html#create-ci-webhooks">Create CI Webhooks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-create-pipeline-webhooks.html#create-cd-webhooks">Create CD Webhooks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-test-cicd-pipelines.html">9. Check Pipeline Webhooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-test-cicd-pipelines.html#check-events-ci-web-hook">Check Events CI Web Hook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-test-cicd-pipelines.html#check-events-cd-web-hook">Check Events CD Web Hook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-test-cicd-pipelines.html#check-gateway-ci-web-hook">Check Gateway CI Web Hook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-test-cicd-pipelines.html#check-gateway-cd-web-hook">Check Gateway CD Web Hook</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-end-to-end-test.html">10. End to End Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#current-status">Ⓐ Current Status</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#change-the-code">Ⓑ Change the code</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#run-ci-pipeline">Ⓒ Run CI pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#running-cd-pipeline-dev">Ⓓ Run CD pipeline (<code>dev</code>)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#running-cd-pipeline-test">Ⓔ Run CD pipeline (<code>test</code>)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Street Java on OpenShift</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Street Java on OpenShift</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Street Java on OpenShift</a></li>
    <li><a href="05-deploy-a-new-version.html">5. Deploy New Version</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/atarazana/street-java-on-openshift-guide/edit/main/documentation/modules/ROOT/pages/05-deploy-a-new-version.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Deploy a new version</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Now, let&#8217;s do something easy, apparently harmless, let&#8217;s build a new image and deploy it. Myabe you didn&#8217;t notice but you were using a pre-built image part of the lab&#8230;&#8203; if you didn&#8217;t notice till now don&#8217;t tell your colleagues, look smart and scratch your chin as if just had another good idea.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="anatomy-of-your-chart"><a class="anchor" href="#anatomy-of-your-chart"></a>Anatomy of your Chart</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You have deployed the Street Java app using a <code>helm chart</code>. Let&#8217;s have a look at the relevant parts of it.</p>
</div>
<div class="paragraph">
<p><strong>The chart</strong></p>
</div>
<div class="paragraph">
<p>The chart resides at <code>helm/street-java</code> there you will find:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Chart.yaml</strong>, definition of the chart and where you define the dependencies</p>
</li>
<li>
<p><strong>charts</strong>, folder containing the chart your chart depend on</p>
</li>
<li>
<p><strong>values.yaml</strong>, general values file that tune youb</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Chart.yaml</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v2
name: street-java <i class="conum" data-value="1"></i><b>(1)</b>
description: Helm Chart to Deploy Street Java

type: application

version: 0.1.0

appVersion: "1.0.0"

dependencies: <i class="conum" data-value="2"></i><b>(2)</b>
  - name: fruit-gateway
  - name: fruit-service</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Chart name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Chart your chart depend on</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>The depencies</strong></p>
</div>
<div class="paragraph">
<p>As you saw above our chart depends on two charts: <code>fruit-gateway</code> and <code>fruit-service</code>.</p>
</div>
<div class="paragraph">
<p>This charts are in folder <code>helm/street-java/charts</code> and each of them consists of the same sections as the general chart: <code>Chart.yaml</code>, <code>charts</code> and <code>values</code> <em>AND</em> another folder; <strong><code>templates</code></strong>.</p>
</div>
<div class="paragraph">
<p>Is in the <code>templates</code> folder where you will find templates to create the <code>Deployments</code>, <code>Services</code>, <code>Routes</code>, <code>ConfigMaps</code>, etc.</p>
</div>
<div class="paragraph">
<p><em>values.yaml</em></p>
</div>
<div class="paragraph">
<p>The <code>values.yaml</code> file is where you can tweak the installation of a chart using different values for certain attributes. In our case there is a general <code>values</code> file and another two for each of the charts <code>fruit-gateway</code> and <code>fruit-service</code>. The primary <code>values</code> file allows you to override the <code>values</code> of the secondary <code>values</code> files.</p>
</div>
<div class="paragraph">
<p>For instance, here you are the values in the primary <code>values.yaml</code> file:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Values for a chart are in a section called as the correponding chart.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">fruit-gateway:
  enabled: true
  image: <i class="conum" data-value="1"></i><b>(1)</b>
    repository: quay.io/atarazana/street-java-fruit-gateway@sha256
    tag: "3d0787554a289b6235f4cd424a2642ed8d5fed41c627a2fe3b8e0acf14272420"
  env:
  - name: FRUIT_SERVICE_URL
    value: "http://fruit-service:8080"
  - name: OTL_ENDPOINT
    value: http://jaeger-all-in-one-inmemory-collector-headless.street-java-infra:4317

fruit-service:
  enabled: false
  image:
    repository: quay.io/atarazana/street-java-fruit-service@sha256
    tag: "3b8ac59ed5a8ddc5edc60f3e3f64690bc36c25582185923a14b90f906d57bb7c"
  env:
  - name: JAVA_OPTS
    value: "-Dspring.profiles.active=openshift -Xms192m -Xmx768m"
  - name: OTL_ENDPOINT
    value: http://jaeger-all-in-one-inmemory-collector-headless.street-java-infra:4317</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hash of the image to use in the <code>fruit-gateway</code> deployment</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pay attention to the values in the primary file for <code>fruit-gateway</code> that are overriden:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">...

image: <i class="conum" data-value="1"></i><b>(1)</b>
  repository: quay.io/atarazana/street-java-fruit-gateway@sha256
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: "4b70587d76955fc02834cad278d39b55a2d96550dc9d460df7a999efc0c4c63a"

...

podSecurityContext: <i class="conum" data-value="2"></i><b>(2)</b>
  runAsNonRoot: true
  seccompProfile:
    type: RuntimeDefault

env: <i class="conum" data-value="1"></i><b>(1)</b>
  - name: FRUIT_SERVICE_URL
    value: "http://fruit-service:8080"
  - name: OTL_ENDPOINT
    value: http://jaeger-all-in-one-inmemory-collector-headless:4317
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>These sections are overriden in the primary values file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This section is not overriden</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-a-new-version"><a class="anchor" href="#building-a-new-version"></a>Building a New Version</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we actually deploy a new version we have to make a change in the code and build the new image.</p>
</div>
<div class="paragraph">
<p>Please, open <code>fruit-gateway/src/main/resources/application.properties</code> and change the value of property <code>config.service.name</code> to <code>fruit-gateway</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">config.service.name=fruit-gateway</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now build the image:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">./fruit-gateway/image-build.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the expected result:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">[INFO] Scanning for projects...
[INFO]
[INFO] ---------------&lt; com.redhat.fruit.gateway:fruit-gateway &gt;---------------
[INFO] Building fruit-gateway 1.0.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
...
STEP 7/10: EXPOSE 8080
--&gt; 0c5aa64d56d
STEP 8/10: USER 185
--&gt; f717045bae2
STEP 9/10: ENV JAVA_OPTS="-Dquarkus.http.host=0.0.0.0 -Djava.util.logging.manager=org.jboss.logmanager.LogManager"
--&gt; 2444b45014e
STEP 10/10: ENV JAVA_APP_JAR="/deployments/quarkus-run.jar"
COMMIT street-java-fruit-gateway:a7d7a1534ca13c67de3472bb7d4e06cf3d0d59f5
--&gt; 96295501f61
Successfully tagged localhost/street-java-fruit-gateway:a7d7a1534ca13c67de3472bb7d4e06cf3d0d59f5
96295501f6153f19c3a6e389fd76741eece0b7afd7b135c052f2f5612d702f40</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pushing-new-image"><a class="anchor" href="#pushing-new-image"></a>Pushing New Image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once we have our new image we have to push it to the image registry. In this lab we have installed Quay for you so that you use it as you would use your own enterprise registry.</p>
</div>
<div class="paragraph">
<p>In order to copy the image you&#8217;re going to use <code>skopeo</code>, if you want to learn more about this utility go to <a href="https://skopeo.io">skopeo</a>.</p>
</div>
<div class="paragraph">
<p>Before you can copy the image to need to log in the registry server:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">skopeo login -u %USERNAME% -p %PASSWORD% myregistry-quay-quay-system.apps.%BASE_SUBDOMAIN%</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see this message:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">Login Succeeded!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run this command to load some environment variables:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">export PROJECT_ID=street-java
export ARTIFACT_VERSION=$(mvn -f fruit-gateway/pom.xml help:evaluate -Dexpression=project.version -q -DforceStdout)
export ARTIFACT_ID=$(mvn -f fruit-gateway/pom.xml help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
export GIT_HASH=$(git rev-parse HEAD)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you&#8217;re logged in and the environmen is set, let&#8217;s copy the image:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">skopeo copy containers-storage:localhost/${PROJECT_ID}-${ARTIFACT_ID}:${GIT_HASH} docker://myregistry-quay-quay-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/${PROJECT_ID}-${ARTIFACT_ID}:${GIT_HASH}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it all goes well, you will see messages like these:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">Getting image source signatures
Copying blob 74cf83aebece done
Copying blob c1488d110df8 done
Copying blob e96a181d185e done
Copying blob 2a4dd233679f done
Copying blob 75d18d488805 done
Copying blob ef0796b11c39 done
Copying config 99824e01cb done
Writing manifest to image destination
Storing signatures</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-the-image-digest"><a class="anchor" href="#getting-the-image-digest"></a>Getting the Image Digest</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Finally let&#8217;s obtain the digest of the image you just pushed to the registry, you will needed later:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">export IMAGE_DIGEST_RAW=$(skopeo inspect docker://myregistry-quay-quay-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/${PROJECT_ID}-${ARTIFACT_ID}:${GIT_HASH} | jq -r .Digest)
export IMAGE_DIGEST=${IMAGE_DIGEST_RAW:7}
echo ${IMAGE_DIGEST}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will get a string like this:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">b9c14b03f13206dd25e92a629d8d8d6709132b25b68a39f648c8dee3d57a0bb9</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="update-image-digest"><a class="anchor" href="#update-image-digest"></a>Update the Image Digest in values.yaml</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s time to update the digest of the new <code>fruit-gateway</code> image in the primary <code>values.yaml</code> file. Open <code>./helm/street-java/values.yaml</code> locate these properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">fruit-gateway:
  enabled: true
  image:
    repository: quay.io/atarazana/street-java-fruit-gateway@sha256
    tag: "3d0787554a289b6235f4cd424a2642ed8d5fed41c627a2fe3b8e0acf14272420"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Substitute <code>repository</code> with the one below, and substite the string <code>NEW_TAG</code> with the digest you got before and that should be in the environment variable <code>IMAGE_DIGEST</code>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">fruit-gateway:
  enabled: true
  image:
    repository: myregistry-quay-quay-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/street-java-fruit-gateway@sha256
    tag: "NEW_TAG"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have changed the values of <code>fruit-gateway&#8594;image&#8594;repository</code> and <code>fruit-gateway&#8594;image&#8594;tag</code> please run this command to upgrade the helm chart:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">helm upgrade street-java helm/street-java</code></pre>
</div>
</div>
<div class="paragraph">
<p>Expect and output similar to this one:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">Release "street-java" has been upgraded. Happy Helming!
NAME: street-java
LAST DEPLOYED: Mon Feb 20 18:31:59 2023
NAMESPACE: street-java-%USERNAME%
STATUS: deployed
REVISION: 2</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="did-it-work"><a class="anchor" href="#did-it-work"></a>Did it Work?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s find out it our app still works properly. If you open the next link and pay attention to the <code>fruit-gateway</code> deployment.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">fruit-gateway-street-java-%USERNAME%.apps.%BASE_SUBDOMAIN%</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or run the next command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl <a href="https://$(oc" class="bare">https://$(oc</a> get route/fruit-gateway -o jsonpath='{.spec.host}')/api/fruits</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will think that yes&#8230;&#8203; it&#8217;s still there alive and kicking&#8230;&#8203; but the devil is in the details&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look to the deployment object:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get deployment/fruit-gateway -n street-java-%USERNAME% -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you should get something like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">...
status:
  availableReplicas: 1
  conditions:
  - lastTransitionTime: "2023-02-20T18:26:04Z"
    lastUpdateTime: "2023-02-20T18:26:04Z"
    message: Deployment has minimum availability.
    reason: MinimumReplicasAvailable
    status: "True"
    type: Available
  - lastTransitionTime: "2023-02-20T18:39:34Z"
    lastUpdateTime: "2023-02-20T18:39:34Z"
    message: ReplicaSet "fruit-gateway-d5b78849b" has timed out progressing.
    reason: ProgressDeadlineExceeded
    status: "False"
    type: Progressing <i class="conum" data-value="1"></i><b>(1)</b>
  observedGeneration: 4
  readyReplicas: 1
  replicas: 2
  unavailableReplicas: 1
  updatedReplicas: 1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It&#8217;s progressing!</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ok, so it&#8217;s still working but with the previous image&#8230;&#8203; that means we have to keep digging.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="events"><a class="anchor" href="#events"></a>Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One way to find out why something is not working properly is having a look to the <code>Events</code> stream.</p>
</div>
<div class="paragraph">
<p>Run this command</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get events -n street-java-%USERNAME% | grep Failed</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see some good candidates like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">17m         Warning   Failed              pod/fruit-gateway-d5b78849b-jmt7d     Failed to pull image "myregistry-quay-quay-system.apps.cluster-fcj9p.fcj9p.sandbox1011.opentlc.com/user1/street-java-fruit-gateway@sha256:b9c14b03f13206dd25e92a629d8d8d6709132b25b68a39f648c8dee3d57a0bb9": rpc error: code = Unknown desc = reading manifest sha256:b9c14b03f13206dd25e92a629d8d8d6709132b25b68a39f648c8dee3d57a0bb9 in myregistry-quay-quay-system.apps.cluster-fcj9p.fcj9p.sandbox1011.opentlc.com/user1/street-java-fruit-gateway: unauthorized: access to the requested resource is not authorized
17m         Warning   Failed              pod/fruit-gateway-d5b78849b-jmt7d     Error: ErrImagePull
17m         Warning   Failed              pod/fruit-gateway-d5b78849b-jmt7d     Error: ImagePullBackOff</code></pre>
</div>
</div>
<div class="paragraph">
<p>It looks like the new image we just pushed to our enterprise registry cannot be pulled. That should ring a bell&#8230;&#8203; maybe the repository we created by pushing a <strong>first</strong> image has created a <strong>private</strong> registry&#8230;&#8203; Let&#8217;s find out.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
At the end of the first line you will find this message <em>unauthorized: access to the requested resource is not authorized</em>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open the next link to the registry and check if our guess is correct.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use this credentials:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>User:</strong> %USERNAME%</p>
</li>
<li>
<p><strong>Password:</strong> %PASSWORD%</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://myregistry-quay-quay-system.apps.%BASE_SUBDOMAIN%/repository/%USERNAME%/street-java-fruit-gateway</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="04-limit-what.html" class="query-params-link">4. Limit What?</a></span>
  <span class="next"><a href="06-deploy-cicd-pipelines-with-gitops.html" class="query-params-link">6. Deploy CICD Pipelines</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
