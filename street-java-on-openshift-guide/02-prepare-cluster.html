<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Prepare Cluster :: Street Java on OpenShift</title>
    <link rel="canonical" href="https://atarazana.github.io/street-java-on-openshift-guide/street-java-on-openshift-guide/02-prepare-cluster.html">
    <link rel="prev" href="01-setup.html">
    <link rel="next" href="03-deploy-the-app.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://atarazana.github.io/street-java-on-openshift-guide">Street Java on OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="street-java-on-openshift-guide" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Street Java on OpenShift</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#openshift">Setup OpenShift 4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#download-tutorial">Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-prepare-cluster.html">2. Prepare Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploying-core-components">Deploying core components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#high-level-tests">High Level Tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#checking-quay">Checking Quay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-deploy-the-app.html">3. Deploy The App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-deploy-the-app.html#checking-helm-cli">Checking helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-deploy-the-app.html#installing-street-java">Installing Street Java</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-limit-what.html">4. Limit What?</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#checking-deployments">Checking Deployments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#limits">Limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#limitrange-anatomy">LimitRange Anatomy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#getting-rid-of-the-limirange">Getting Rid of the LimitRange</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#checking-the-app">Checking the App</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-deploy-a-new-version.html">5. Deploy New Version</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#anatomy-of-your-chart">Anatomy of your Chart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#building-a-new-version">Building a New Version</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#pushing-new-image">Pushing New Image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#getting-the-image-digest">Getting the Image Digest</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#update-image-digest">Update the Image Digest</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#did-it-work">Did it Work?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#events">Events</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-good-robot.html">6. Good Robot</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-good-robot.html#create-root-account-in-quay">Create Quay Robot Acc.</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-good-robot.html#create-registry-secret">Create Registry Secret</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-good-robot.html#grant-pull-permissions">Granting Pull Permissions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-checking-cicd-pipelines.html">7. Checking CICD Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-checking-cicd-pipelines.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-checking-cicd-pipelines.html#tekton-triggers">Tekton Triggers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-create-pipeline-webhooks.html">8. Create Pipelines Webhooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-create-pipeline-webhooks.html#pipeline-webhooks">Pipelines Webhooks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-create-pipeline-webhooks.html#create-ci-webhooks">Create CI Webhooks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-create-pipeline-webhooks.html#create-cd-webhooks">Create CD Webhooks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-test-cicd-pipelines.html">9. Check Pipeline Webhooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-test-cicd-pipelines.html#check-events-ci-web-hook">Check Events CI Web Hook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-test-cicd-pipelines.html#check-events-cd-web-hook">Check Events CD Web Hook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-test-cicd-pipelines.html#check-gateway-ci-web-hook">Check Gateway CI Web Hook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-test-cicd-pipelines.html#check-gateway-cd-web-hook">Check Gateway CD Web Hook</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-end-to-end-test.html">10. End to End Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#current-status">Ⓐ Current Status</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#change-the-code">Ⓑ Change the code</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#run-ci-pipeline">Ⓒ Run CI pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#running-cd-pipeline-dev">Ⓓ Run CD pipeline (<code>dev</code>)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-end-to-end-test.html#running-cd-pipeline-test">Ⓔ Run CD pipeline (<code>test</code>)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Street Java on OpenShift</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Street Java on OpenShift</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Street Java on OpenShift</a></li>
    <li><a href="02-prepare-cluster.html">2. Prepare Cluster</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/atarazana/street-java-on-openshift-guide/edit/main/documentation/modules/ROOT/pages/02-prepare-cluster.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Prepare Cluster</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section is devoted to prepare the OpenShift cluster, hence something to be done before actually run the proper GitOps lab.</p>
</div>
<div class="paragraph">
<p>Everything we do in this section requires that you have fulfilled the <a href="01-setup.html#prerequisite" class="xref page">prerequisites</a> section, that you&#8217;re logged in your OpenShift cluster and you have <code>cluster-admin</code> permissions on it.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t have an OpenShift cluster and/or you don&#8217;t have <code>cluster-admin</code> permissions on it you could for instance using <a href="https://try.openshift.com">try.openshift.com</a>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Run this section only if you&#8217;re preparing the lab environment</strong> and as a <code>cluster-admin</code> user. If you just want to run the lab then proceed to the  <a href="03-prepare-repositories.html" class="xref page">next section</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So if you are not already logged in, please do it now.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc login -u %USERNAME% -p %PASSWORD% --server=https://api.%BASE_SUBDOMAIN%:6443</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the API server you&#8217;re trying to log in uses a self-signed certificate or otherwise non trusted CA you will receive this message</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">The server uses a certificate signed by an unknown authority.
You can bypass the certificate check, but any data you send to the server could be intercepted by others.
Use insecure connections? (y/n):</code></pre>
</div>
</div>
<div class="paragraph">
<p>Type 'y' only if you trust the server!</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-core-components"><a class="anchor" href="#deploying-core-components"></a>Deploying core components</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to run this guide we&#8217;re going to need several components, more prominently:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ArgoCD</strong>, the GitOps engine supported by Red Hat through the <strong>OpenShift GitOps operator</strong></p>
</li>
<li>
<p><strong>Tekton</strong>, the <em>de facto</em> kubernetes native CICD pipelines system supported by Red Hat through the <strong>OpenShift Pipelines operator</strong></p>
</li>
<li>
<p><strong>Quay</strong>, Red Hat&#8217;s container registry</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s install all of them:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">until oc apply -k util/bootstrap/; do sleep 2; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command execute <code>oc apply -k &#8230;&#8203;</code> until it&#8217;s done every 2 seconds&#8230;&#8203; this is so because behind scenes some tasks are run asynchronously and in the meantime some errors will be seen as in the next example. The number of errors decreases as components are installed until there are no errors.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ until oc apply -k util/bootstrap/; do sleep 2; done
namespace/openshift-storage created
namespace/quay-system created
serviceaccount/occli created
serviceaccount/occli created
clusterrole.rbac.authorization.k8s.io/gitops-guide-user-role created
clusterrole.rbac.authorization.k8s.io/gitops-service-account created
rolebinding.rbac.authorization.k8s.io/occli-permission created
rolebinding.rbac.authorization.k8s.io/occli-permission created
clusterrolebinding.rbac.authorization.k8s.io/gitops-guide-user-role-binding created
clusterrolebinding.rbac.authorization.k8s.io/gitops-service-account created
job.batch/noobaa-patch created
job.batch/quay-deploy created
operatorgroup.operators.coreos.com/openshift-storage-og created
subscription.operators.coreos.com/openshift-gitops-operator created
subscription.operators.coreos.com/openshift-pipelines-operator created
subscription.operators.coreos.com/quay-operator created
subscription.operators.coreos.com/odf-operator created
route.route.openshift.io/s3-insecure created
group.user.openshift.io/gitops-guide-users created
unable to recognize "util/bootstrap/": no matches for kind "AppProject" in version "argoproj.io/v1alpha1"
unable to recognize "util/bootstrap/": no matches for kind "AppProject" in version "argoproj.io/v1alpha1"
unable to recognize "util/bootstrap/": no matches for kind "ArgoCD" in version "argoproj.io/v1alpha1"
unable to recognize "util/bootstrap/": no matches for kind "BackingStore" in version "noobaa.io/v1alpha1"
unable to recognize "util/bootstrap/": no matches for kind "NooBaa" in version "noobaa.io/v1alpha1"
unable to recognize "util/bootstrap/": no matches for kind "ObjectBucketClaim" in version "objectbucket.io/v1alpha1"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="high-level-tests"><a class="anchor" href="#high-level-tests"></a>High level tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s open the OpenShift Web Console and run some validation tests.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://console-openshift-console.apps.%BASE_SUBDOMAIN%</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see something like.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can skip the tour or run it if you want and have time.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/openshift-console.png" alt="OpenShift Web Console">
</div>
</div>
<div class="paragraph">
<p>Now, take a look to the next picture, there are two arrows pointing to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The ArgoCD web console link</p>
</li>
<li>
<p>The Pipelines section</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-pipelines-test-1.png" alt="High level tests 1">
</div>
</div>
<div class="paragraph">
<p>You can see both then we&#8217;re on the good way.</p>
</div>
<div class="paragraph">
<p>Open the ArgoCD web console then click on the "LOG IN VIA OPENSHIFT" button on the upper right corner and use your credentials:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The first time you successfully log in you&#8217;ll see an Authorize Access request, leave it "as is"  and click on the button that says "Allow selected permissions"
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-login.png" alt="ArgoCD Log In">
</div>
</div>
<div class="paragraph">
<p>Finally if all went well you should land in the ArgoCD console and see this.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-console.png" alt="ArgoCD Console">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="checking-quay"><a class="anchor" href="#checking-quay"></a>Checking Quay</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First of, open the OpenShift console and go to the topology view of namespace <code>quay-system</code>, use the following link.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://console-openshift-console.apps.%BASE_SUBDOMAIN%/k8s/cluster/projects/quay-system/workloads?view=graph</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see something similar to this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quay-installed-topology.png" alt="Quay Topology">
</div>
</div>
<div class="paragraph">
<p>Please open Quay Console in another tab or browser window.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://myregistry-quay-quay-system.apps.%BASE_SUBDOMAIN%</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quay-installed-login.png" alt="Quay Login">
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="01-setup.html" class="query-params-link">1. Setup</a></span>
  <span class="next"><a href="03-deploy-the-app.html" class="query-params-link">3. Deploy The App</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
