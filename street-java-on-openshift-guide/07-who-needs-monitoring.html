<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Who Needs Monitoring :: Street Java on OpenShift</title>
    <link rel="canonical" href="https://atarazana.github.io/street-java-on-openshift-guide/street-java-on-openshift-guide/07-who-needs-monitoring.html">
    <link rel="prev" href="06-good-robot.html">
    <link rel="next" href="08-finding-the-needle.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://atarazana.github.io/street-java-on-openshift-guide">Street Java on OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="street-java-on-openshift-guide" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Street Java on OpenShift</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#openshift">Setup OpenShift 4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#download-tutorial">Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-prepare-cluster.html">2. Prepare Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#deploying-core-components">Deploying core components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#high-level-tests">High Level Tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#checking-quay">Checking Quay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-deploy-the-app.html">3. Deploy The App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-deploy-the-app.html#checking-helm-cli">Checking helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-deploy-the-app.html#installing-street-java">Installing Street Java</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-limit-what.html">4. Limit What?</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#checking-deployments">Checking Deployments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#limits">Limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#limitrange-anatomy">LimitRange Anatomy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#getting-rid-of-the-limirrange">Getting Rid of the LimitRange</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#checking-the-app">Checking the App</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-deploy-a-new-version.html">5. Deploy New Version</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#anatomy-of-your-chart">Anatomy of your Chart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#building-a-new-version">Building a New Version</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#pushing-new-image">Pushing New Image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#getting-the-image-digest">Getting the Image Digest</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#update-image-digest">Update the Image Digest</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#did-it-work">Did it Work?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#events">Events</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-good-robot.html">6. Good Robot</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-good-robot.html#create-root-account-in-quay">Create Quay Robot Acc.</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-good-robot.html#create-registry-secret">Create Registry Secret</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-good-robot.html#grant-pull-permissions">Granting Pull Permissions</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-who-needs-monitoring.html">7. Who Needs Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#the-needle">The Needle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-finding-the-needle.html">8. The Needle in The Haystack</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-finding-the-needle.html#the-needle">The Needle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-finding-the-needle.html#the-haystack">The Haystack</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-finding-the-needle.html#fixing-the-problem">Fixing The Problem</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Street Java on OpenShift</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Street Java on OpenShift</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Street Java on OpenShift</a></li>
    <li><a href="07-who-needs-monitoring.html">7. Who Needs Monitoring</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/atarazana/street-java-on-openshift-guide/edit/main/documentation/modules/ROOT/pages/07-who-needs-monitoring.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Who Needs Monitoring</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Who needs monitoring, right?</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/this-is-fine.jpg" alt="alt"></span></p>
</div>
<div class="paragraph">
<p>Well in case you think it&#8217;s a good idea to monitor your application then keep reading and doing!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-monitoring-stack"><a class="anchor" href="#the-monitoring-stack"></a>The Monitoring Stack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In OpenShift with regards to monitoring we use <a href="https://prometheus.io">Prometheus</a> as the more prominent piece of software, <a href="https://thanos.io">Thanos</a> is the other piece. In OpenShift monitoring is a key subject, you can read more about it <a href="https://docs.openshift.com/container-platform/4.12/monitoring/monitoring-overview.html">here</a>.</p>
</div>
<div class="paragraph">
<p>For this lab, let&#8217;s concentrate on Prometheus. Prometheus is installed and maintained by an operator, the installation of an OpenShift cluster already takes care of installing Prometheus and maintaining it using the operator.</p>
</div>
<div class="paragraph">
<p>In case you don&#8217;t know what an operator is please read <a href="https://www.redhat.com/en/technologies/cloud-computing/openshift/what-are-openshift-operators">this</a>. But for the sake of simplicity for now consider an operator as specialized logic run as a pod in a kubernetes cluster that takes care of installing and maintaining a system based on yaml definitions called <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources">CRD</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s get up to speed with regards to Prometheus. Prometheus is an open-source systems monitoring and alerting toolkit collects and stores its metrics as time series data, i.e. metrics information is stored with the timestamp at which it was recorded, alongside optional key-value pairs called labels.</p>
</div>
<div class="paragraph">
<p>Please note that Prometheus works with the typical behavior you&#8217;ve probably seen in real life&#8230;&#8203; Don&#8217;t call us we&#8217;ll call you. Well Prometheus will call your workloads and expects metrics from it in a specific format. This means in our case where we have an Operator taking care of Prometheus that you have to crete an object of type <code>ServiceMonitor</code> that on one hand specifies a selector to find the kubernetes <code>Services</code> and on the other hand specifies the uri to call to get the metrics from.</p>
</div>
<div class="paragraph">
<p>Please, find bellow an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    k8s-app: prometheus
  name: monitor
spec:
  endpoints:
    - interval: 30s
      path: /actuator/prometheus <i class="conum" data-value="1"></i><b>(1)</b>
      port: http
  namespaceSelector: <i class="conum" data-value="2"></i><b>(2)</b>
    any: true
  selector: <i class="conum" data-value="3"></i><b>(3)</b>
    matchLabels:
      monitored: prometheus</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uri to call and how often</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Namespaces to look for the Service compliant with our search</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Selector to find the Services objects that expose metrics in the given uri/path</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="an-spurious-error"><a class="anchor" href="#an-spurious-error"></a>An Spurious Error</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Maybe in the code of your app there are errors that manifest only under certain circumstances&#8230;&#8203; or randomly. Inadvertently you have injected an error somewhere. Let&#8217;s execute a simple test, please run this command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">for i in {1..20}; do curl -s <a href="https://$(oc" class="bare">https://$(oc</a> get route/fruit-gateway -o jsonpath='{.spec.host}')/api/config | | jq .status.status ; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get an output similar to this one:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">"OPERATIONAL"
"DEGRADED"
...
"OPERATIONAL"
"DEGRADED"
"DEGRADED"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In general you won&#8217;t find an error of this kind this way. Instead, you need a way to define a base line and detect abnormal situations, deviation from that baseline, etc.</p>
</div>
<div class="paragraph">
<p>One way to generate this baseline is defining custom logic/business related metrics. This means we have to do two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate prometheus compliant metrics using a library preferably from our code</p>
</li>
<li>
<p>Configure Prometheus using a ServiceMonitor so that it can scrape the metrics we&#8217;re generating.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This api <code>/api/config</code> is meant to reveal problems&#8230;&#8203; it could be a good candidate to define our baseline.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="designing-the-metrics-baseline"><a class="anchor" href="#designing-the-metrics-baseline"></a>Designing the metrics baseline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Counting errors or calculating an error rate could be a good idea&#8230;&#8203; in general errors should tend to zero, so if that is not the case then our application is not behaving properly.</p>
</div>
<div class="paragraph">
<p>Ok, so we have to create a counter and increment the counter whenever an error happens then we&#8217;ll be able to detect problems that won&#8217;t be detected otherwise.</p>
</div>
<div class="paragraph">
<p>Well, let&#8217;s start by modifying the code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generating-metrics"><a class="anchor" href="#generating-metrics"></a>Generating Metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You&#8217;re going to add some code to generate metrics to <code>fruit-gateway</code>, this is a <a href="https://quarkus.io">Quarkus</a> application and in order to do that you need an extension (library). Let&#8217;s add the extension named <code>micrometer-registry-prometheus</code>:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
More information about the library <a href="https://quarkus.io/guides/micrometer">here</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">mvn quarkus:add-extensions -Dextensions='micrometer-registry-prometheus'</code></pre>
</div>
</div>
<div class="paragraph">
<p>After successfully adding the library you should see this:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">[INFO] Scanning for projects...
[INFO]
[INFO] ---------------&lt; com.redhat.fruit.gateway:fruit-gateway &gt;---------------
[INFO] Building fruit-gateway 1.0.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
[INFO]
[INFO] --- quarkus-maven-plugin:2.15.3.Final:add-extensions (default-cli) @ fruit-gateway ---
[INFO] [SUCCESS] âœ…  Extension io.quarkus:quarkus-micrometer-registry-prometheus has been installed
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  1.909 s
[INFO] Finished at: 2023-04-25T11:01:00+02:00
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you open <code>./fruit-gateway/pom.xml</code> you&#8217;ll find this new dependency.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-micrometer-registry-prometheus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that our library is in place we have plant the code that generates the counter of errors in a format Prometheus understands.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding-metrics-code"><a class="anchor" href="#adding-metrics-code"></a>Adding Metrics Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Open file <code>fruit-gateway/src/main/java/com/redhat/fruit/gateway/ApiImpl.java</code> and locate the FruitService rest client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Inject
    @RestClient
    FruitService fruitService;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add the metrics registry, the SDK we need to create and feed the error counter. Place the following code right under the rest client.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the corresponding import statement is not automatically added, add it yourself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.micrometer.core.instrument.MeterRegistry;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Inject
    MeterRegistry registry;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now search for this around line 60. Pay attention to <strong>1</strong> and <strong>2</strong> because these areas are good candidates to count errors related to api <code>/api/config</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    Check[] checks = new Check[1];
    String status = "OPERATIONAL";
    try {
        Status fruitServiceStatus = fruitService.health();
        logger.info(String.format("FruitService status: %s",fruitServiceStatus.getStatus()));
        String fruitServiceName = fruitService.serviceName();
        logger.info(String.format("FruitService name: %s",fruitServiceName));
        if (!"UP".equals(fruitServiceStatus.getStatus())) {
            status = "DEGRADED"; <i class="conum" data-value="1"></i><b>(1)</b>
            checks[0] = new Check(fruitServiceName, "DOWN");
        } else {
            checks[0] = new Check(fruitServiceName, "UP");
        }
    } catch (Exception e) {
        logger.error(e, e);
        status = "DEGRADED"; <i class="conum" data-value="2"></i><b>(2)</b>
        checks = new Check[1];
        checks[0] = new Check("backend-service", "DOWN");
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This code is run if backend service reports as degraded.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This code is run if there&#8217;s an exception checking backend.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally add the following code in the next line to point 1 and 2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">registry.counter(ACC_ERRORS_COUNT_NAME).increment();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is how it should look after changes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>ACC_ERRORS_COUNT_NAME</strong> is defined in class <code>ApiResource</code> and it&#8217;s value is <code>acc_errors_count</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        Check[] checks = new Check[1];
        String status = "OPERATIONAL";
        try {
            Status fruitServiceStatus = fruitService.health();
            logger.info(String.format("FruitService status: %s",fruitServiceStatus.getStatus()));
            String fruitServiceName = fruitService.serviceName();
            logger.info(String.format("FruitService name: %s",fruitServiceName));
            if (!"UP".equals(fruitServiceStatus.getStatus())) {
                status = "DEGRADED";
                registry.counter(ACC_ERRORS_COUNT_NAME).increment(); <i class="conum" data-value="1"></i><b>(1)</b>
                checks[0] = new Check(fruitServiceName, "DOWN");
            } else {
                checks[0] = new Check(fruitServiceName, "UP");
            }
        } catch (Exception e) {
            logger.error(e, e);
            status = "DEGRADED";
            registry.counter(ACC_ERRORS_COUNT_NAME).increment(); <i class="conum" data-value="2"></i><b>(2)</b>
            checks = new Check[1];
            checks[0] = new Check("backend-service", "DOWN");
        }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Incrementing counter</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Incrementing counter</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The error counter is in place, it&#8217;s time to check if the counter is really working. We can do this locally, because the metrics are exposed by the service, no connection to Prometheus needed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="checking-metrics-locally"><a class="anchor" href="#checking-metrics-locally"></a>Checking Metrics Locally</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First of all, if metrics are exposed which is the uri to consume them in our quarkus application? The answer is: <code>/q/metrics</code> in the case of Spring Boot, in general you&#8217;ll find them at <code>/actuator/prometheus</code>.</p>
</div>
<div class="paragraph">
<p>Open a terminal and change to dir <code>street-java-guide/fruit-gateway</code>, once there run this command:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This command starts our application (quarkus) locally in development mode.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">mvn quarkus:dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see an output similar to this one.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">...
Factory] (executor-thread-1) inHeaders: [Accept=*/*,Accept-Encoding=gzip, deflate, br,Accept-Language=en-GB,en-US;q=0.9,en;q=0.8,es;q=0.7,Connection=keep-alive,Host=localhost:8080,Referer=http://localhost:8080/,sec-ch-ua="Google Chrome";v="111", "Not(A:Brand";v="8", "Chromium";v="111",sec-ch-ua-mobile=?0,sec-ch-ua-platform="macOS",Sec-Fetch-Dest=empty,Sec-Fetch-Mode=cors,Sec-Fetch-Site=same-origin,User-Agent=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36]

10:54:12 INFO  traceId=a60da9b2cb9d20d99d9fb272bd8a1cfb, parentId=, spanId=fbb4fda668637025, sampled=true [co.re.fr.ga.re.RequestHeaderFactory] (executor-thread-1) {X-B3-SpanId=[fbb4fda668637025], x-owner=[carlos], X-B3-ParentSpanId=[], X-B3-TraceId=[a60da9b2cb9d20d99d9fb272bd8a1cfb]}
10:54:12 INFO  traceId=a60da9b2cb9d20d99d9fb272bd8a1cfb, parentId=, spanId=fbb4fda668637025, sampled=true [co.re.fr.ga.ApiImpl] (executor-thread-1) FruitService name: fruit-service

--
Tests paused
Press [r] to resume testing, [o] Toggle test output, [:] for the terminal, [h] for more options&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s think a little here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The code registering and incrementing the metric will be run if a call to the api <code>/api/config</code> is sent to the port (8080) is listening locally (localhost) and fails.</p>
</li>
<li>
<p>The back end is not running where it&#8217;s expected in development mode <a href="http://localhost:8081" class="bare">http://localhost:8081</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So if we inspect the metrics url, and look for metric <code>acc_error_count</code> you will find nothing. You can open the URL in a browser or run this command, in a different terminal, to check this.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -s <a href="http://localhost:8080/q/metrics" class="bare">http://localhost:8080/q/metrics</a> | grep -i acc_errors_count</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to see if the counter works let&#8217;s run some GET requests to the <code>/api/config</code> and see if the count matches the number of requests, in this case <strong>20</strong>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">for i in {1..20}; do curl -s <a href="http://localhost:8080/api/config" class="bare">http://localhost:8080/api/config</a> | jq .status.status ; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s inspect the metric again:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -s <a href="http://localhost:8080/q/metrics" class="bare">http://localhost:8080/q/metrics</a> | grep -i acc_errors_count</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time you should get this output, an as expected the counter should read <strong>20.0</strong>.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh"># HELP acc_errors_count_total
# TYPE acc_errors_count_total counter
acc_errors_count_total 20.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Awesome, the counter counts errors when checking the backend we have our baseline.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In general we should expect no errors, our baseline&#8230;&#8203; and raise and alert if that is not the case.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-metrics-enabled-version"><a class="anchor" href="#deploy-metrics-enabled-version"></a>Deploy Metrics Enabled Version</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now you have to repeat the steps necessary to <a href="05-deploy-a-new-version.html#building-a-new-version" class="xref page">build</a>, <a href="05-deploy-a-new-version.html#pushing-new-image" class="xref page">push</a>, etc. and deploy the new image as you did before.</p>
</div>
<div class="paragraph">
<p>Once yo have deployed the new image, metrics should be available, let&#8217;s check if the application is already running and working properly (although you should have tested it as part of the steps referred before).</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -s <a href="https://$(oc" class="bare">https://$(oc</a> get route/fruit-gateway -o jsonpath='{.spec.host}')/hello</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="checking-metrics-in-openshift"><a class="anchor" href="#checking-metrics-in-openshift"></a>Checking Metrics In OpenShift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you are sure the application has been deployed correctly and apparently works as before. Run this command to</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">for i in {1..20}; do curl -s <a href="https://$(oc" class="bare">https://$(oc</a> get route/fruit-gateway -o jsonpath='{.spec.host}')/api/config | jq .status.status ; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s inspect the metric again:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -s <a href="https://$(oc" class="bare">https://$(oc</a> get route/fruit-gateway -o jsonpath='{.spec.host}')/q/metrics | grep -i acc_errors_count</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-service-monitors"><a class="anchor" href="#creating-service-monitors"></a>Creating ServiceMonitors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create the <code>ServiceMonitor</code> object to monitor <code>fruit-gateway</code>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc apply -f - &lt;&lt;EOF
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    k8s-app: prometheus
  name: fruit-gateway-monitor
  namespace: street-java-%USERNAME%
spec:
  endpoints:
    - interval: 30s
      path: /q/metrics
      port: http
  namespaceSelector:
    matchNames:
    - street-java-%USERNAME%
  selector:
    matchLabels:
      app.kubernetes.io/name: fruit-gateway
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alright once <code>ServiceMonitor</code> are in place Prometheus will start scrapping metrics every number of seconds (30s in our examples). This means that those metrics should be available somewhere for querying.</p>
</div>
<div class="paragraph">
<p>Please open the next link in a new tab.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://console-openshift-console.apps.%BASE_SUBDOMAIN%/dev-monitoring/ns/street-java-%USERNAME%/metrics</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then click on <strong>Select query</strong> and choose <strong>Custom query</strong>.</p>
</div>
<div class="paragraph">
<p>Finally on the text area saying <strong>Expression (press&#8230;&#8203;)</strong> start typing <strong>acc_errors_count</strong> and choose the metric called <strong>acc_errors_count_total</strong> and type the <kbd>Return</kbd> key.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-alerts"><a class="anchor" href="#create-alerts"></a>Create Alerts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you define a baseline, then you can define alerts to be triggered whenever the baseline is crossed.</p>
</div>
<div class="paragraph">
<p>Create the <code>PrometheusRule</code> object raise alerts related to <code>fruit-gateway</code>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc apply -f - &lt;&lt;EOF
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: fruit-gateway-alert-rules
  namespace: street-java-%USERNAME%
  labels:
    openshift.io/prometheus-rule-evaluation-scope: leaf-prometheus
spec:
  groups:
  - name: fruit-gateway-monitoring
    rules:
    - alert: too-many-accumulated-errors
      annotations:
        description: 'accumulated errors'
        summary: Too many accumulated errors
      expr: acc_errors_count_total &gt; 4
      for: 1m
      labels:
        severity: warning
EOF</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="digging-deeper"><a class="anchor" href="#digging-deeper"></a>Digging Deeper</h2>
<div class="sectionbody">
<div class="paragraph">
<p>But where is this error happening? How can I find out in an OpenShift cluster?</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="06-good-robot.html" class="query-params-link">6. Good Robot</a></span>
  <span class="next"><a href="08-finding-the-needle.html" class="query-params-link">8. The Needle in The Haystack</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
