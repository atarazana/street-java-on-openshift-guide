<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Who Needs Monitoring :: Street Java on OpenShift</title>
    <link rel="canonical" href="https://atarazana.github.io/street-java-on-openshift-guide/street-java-on-openshift-guide/07-who-needs-monitoring.html">
    <link rel="prev" href="06-good-robot.html">
    <link rel="next" href="08-finding-the-needle.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://atarazana.github.io/street-java-on-openshift-guide">Street Java on OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="street-java-on-openshift-guide" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Street Java on OpenShift</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#openshift">Setup OpenShift 4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#download-tutorial">Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-prepare-cluster.html">2. Prepare Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#deploying-core-components">Deploying core components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#high-level-tests">High Level Tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#checking-quay">Checking Quay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-deploy-the-app.html">3. Deploy The App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-deploy-the-app.html#checking-helm-cli">Checking helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-deploy-the-app.html#installing-street-java">Installing Street Java</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-limit-what.html">4. Limit What?</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#checking-deployments">Checking Deployments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#limits">Limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#limitrange-anatomy">LimitRange Anatomy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#getting-rid-of-the-limirange">Getting Rid of the LimitRange</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#checking-the-app">Checking the App</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-deploy-a-new-version.html">5. Deploy New Version</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#anatomy-of-your-chart">Anatomy of your Chart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#building-a-new-version">Building a New Version</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#pushing-new-image">Pushing New Image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#getting-the-image-digest">Getting the Image Digest</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#update-image-digest">Update the Image Digest</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#did-it-work">Did it Work?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#events">Events</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-good-robot.html">6. Good Robot</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-good-robot.html#create-root-account-in-quay">Create Quay Robot Acc.</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-good-robot.html#create-registry-secret">Create Registry Secret</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-good-robot.html#grant-pull-permissions">Granting Pull Permissions</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-who-needs-monitoring.html">7. Who Needs Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#the-needle">The Needle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-finding-the-needle.html">8. The Needle in The Haystack</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-finding-the-needle.html#the-needle">The Needle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-finding-the-needle.html#the-haystack">The Haystack</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-finding-the-needle.html#fixing-the-problem">Fixing The Problem</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Street Java on OpenShift</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Street Java on OpenShift</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Street Java on OpenShift</a></li>
    <li><a href="07-who-needs-monitoring.html">7. Who Needs Monitoring</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/atarazana/street-java-on-openshift-guide/edit/main/documentation/modules/ROOT/pages/07-who-needs-monitoring.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Who Needs Monitoring</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Who needs monitoring, right?</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/this-is-fine.jpg" alt="alt"></span></p>
</div>
<div class="paragraph">
<p>Well in case you think it&#8217;s a good idea to monitor your application then keep reading and doing!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-monitoring-stack"><a class="anchor" href="#the-monitoring-stack"></a>The Monitoring Stack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In OpenShift with regards to monitoring we use <a href="https://prometheus.io">Prometheus</a> as the more prominent piece of software, <a href="https://thanos.io">Thanos</a> is the other piece. In OpenShift monitoring is a key subject, you can read more about it <a href="https://docs.openshift.com/container-platform/4.12/monitoring/monitoring-overview.html">here</a>.</p>
</div>
<div class="paragraph">
<p>For this lab, let&#8217;s concentrate on Prometheus. Prometheus is installed and maintained by an operator, the installation of an OpenShift cluster already takes care of installing Prometheus and maintaining it using the operator.</p>
</div>
<div class="paragraph">
<p>In case you don&#8217;t know what an operator is please read <a href="https://www.redhat.com/en/technologies/cloud-computing/openshift/what-are-openshift-operators">this</a>. But for the sake of simplicity for now consider an operator as specialized logic run as a pod in a kubernetes cluster that takes care of installing and maintaining a system based on yaml definitions called <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources">CRD</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s get up to speed with regards to Prometheus. Prometheus is an open-source systems monitoring and alerting toolkit collects and stores its metrics as time series data, i.e. metrics information is stored with the timestamp at which it was recorded, alongside optional key-value pairs called labels.</p>
</div>
<div class="paragraph">
<p>Please note that Prometheus works with the typical behavior you&#8217;ve probably seen in real life&#8230;&#8203; Don&#8217;t call us we&#8217;ll call you. Well Prometheus will call your workloads and expects metrics from it in a specific format. This means in our case where we have an Operator taking care of Prometheus that you have to crete an object of type <code>ServiceMonitor</code> that on one hand specifies a selector to find the kubernetes <code>Services</code> and on the other hand specifies the uri to call to get the metrics from.</p>
</div>
<div class="paragraph">
<p>Please, find bellow an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    k8s-app: prometheus
  name: monitor
spec:
  endpoints:
    - interval: 30s
      path: /actuator/prometheus <i class="conum" data-value="1"></i><b>(1)</b>
      port: http
  namespaceSelector: <i class="conum" data-value="2"></i><b>(2)</b>
    any: true
  selector: <i class="conum" data-value="3"></i><b>(3)</b>
    matchLabels:
      monitored: prometheus</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uri to call and how often</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Namespaces to look for the Service compliant with our search</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Selector to find the Services objects that expose metrics in the given uri/path</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="an-spurious-error"><a class="anchor" href="#an-spurious-error"></a>An Spurious Error</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Maybe in the code of your app there are errors that manifest only under certain circumstances&#8230;&#8203; or randomly. Inadvertently you have injected an error somewhere. Let&#8217;s execute a simple test, please run this command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">for i in {1..20}; do curl -sI <a href="https://$(oc" class="bare">https://$(oc</a> get route/fruit-gateway -o jsonpath='{.spec.host}')/api/config | grep HTTP; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get an output similar to this one:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">HTTP/1.1 200 OK
HTTP/1.1 200 OK
HTTP/1.1 500 Internal Server Error
...
HTTP/1.1 200 OK
HTTP/1.1 200 OK
HTTP/1.1 500 Internal Server Error</code></pre>
</div>
</div>
<div class="paragraph">
<p>In general you want find an error of this kind this way. Instead, you need a way to define a base line and detect abnormal situations, deviation from that baseline, etc.</p>
</div>
<div class="paragraph">
<p>One way to generate this baseline is defining custom logic/business related metrics. This means we have to do two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate prometheus compliant metrics using a library preferably from our code</p>
</li>
<li>
<p>Configure Prometheus using a ServiceMonitor so that it can scrape the metrics we&#8217;re generating.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Well, let&#8217;s start by modifying the code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generating-metrics"><a class="anchor" href="#generating-metrics"></a>Generating Metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You have to generate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-micrometer-registry-prometheus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>But where is this error happening? How can I find out in an OpenShift cluster?</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="06-good-robot.html" class="query-params-link">6. Good Robot</a></span>
  <span class="next"><a href="08-finding-the-needle.html" class="query-params-link">8. The Needle in The Haystack</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
