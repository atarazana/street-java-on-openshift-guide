<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Good Robot :: Street Java on OpenShift</title>
    <link rel="canonical" href="https://atarazana.github.io/street-java-on-openshift-guide/street-java-on-openshift-guide/06-good-robot.html">
    <link rel="prev" href="05-deploy-a-new-version.html">
    <link rel="next" href="07-who-needs-monitoring.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://atarazana.github.io/street-java-on-openshift-guide">Street Java on OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="street-java-on-openshift-guide" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Street Java on OpenShift</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#openshift">Setup OpenShift 4</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#download-tutorial">Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-prepare-cluster.html">2. Prepare Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#deploying-core-components">Deploying core components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#high-level-tests">High Level Tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-prepare-cluster.html#checking-quay">Checking Quay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-deploy-the-app.html">3. Deploy The App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-deploy-the-app.html#checking-helm-cli">Checking helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-deploy-the-app.html#installing-street-java">Installing Street Java</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-limit-what.html">4. Limit What?</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#checking-deployments">Checking Deployments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#limits">Limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#limitrange-anatomy">LimitRange Anatomy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#getting-rid-of-the-limirange">Getting Rid of the LimitRange</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-limit-what.html#checking-the-app">Checking the App</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-deploy-a-new-version.html">5. Deploy New Version</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#anatomy-of-your-chart">Anatomy of your Chart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#building-a-new-version">Building a New Version</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#pushing-new-image">Pushing New Image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#getting-the-image-digest">Getting the Image Digest</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#update-image-digest">Update the Image Digest</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#did-it-work">Did it Work?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-a-new-version.html#events">Events</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-good-robot.html">6. Good Robot</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#create-root-account-in-quay">Create Quay Robot Acc.</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#create-registry-secret">Create Registry Secret</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#grant-pull-permissions">Granting Pull Permissions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-who-needs-monitoring.html">7. Who Needs Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-who-needs-monitoring.html#the-needle">The Needle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-finding-the-needle.html">8. The Needle in The Haystack</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-finding-the-needle.html#the-needle">The Needle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-finding-the-needle.html#the-haystack">The Haystack</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-finding-the-needle.html#fixing-the-problem">Fixing The Problem</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Street Java on OpenShift</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Street Java on OpenShift</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Street Java on OpenShift</a></li>
    <li><a href="06-good-robot.html">6. Good Robot</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/atarazana/street-java-on-openshift-guide/edit/main/documentation/modules/ROOT/pages/06-good-robot.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Good Robot</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Well, apparently you have to add credentials somehow to allow pulling an image from a private repository.</p>
</div>
<div class="paragraph">
<p>In this chapter you will learn how to create credentials and use them to fix this situation.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It&#8217;s a best practice avoid storing secrets in a git repository even if it&#8217;s private. There are several ways to deal with secrets in this kind of scenarios but in this case we&#8217;re going to manage them manually for the sake of simplicity.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-root-account-in-quay"><a class="anchor" href="#create-root-account-in-quay"></a>Create a Robot Account in Quay</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So here comes the good robot of the title. The suggested approach to use credentials to push/pull images from a system, like in this case, is using a <strong>robot account</strong> instead of using a personal account. Next you will learn to create a <strong>robot account</strong> in Quay.</p>
</div>
<div class="paragraph">
<p>Please copy and paste the following link and open it in a browser, then use this credentials and click on <code>Sign in to Red Hat Quay</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Username:</strong> %USERNAME%</p>
</li>
<li>
<p><strong>Password:</strong> openshift</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://myregistry-quay-quay-system.apps.%BASE_SUBDOMAIN%</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quay-installed-login-userX.png" alt="Quay Login">
</div>
</div>
<div class="paragraph">
<p>Now click on <code>userX</code> to jump to the user details section.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quay-installed-repositories-userX.png" alt="Go to Repositories">
</div>
</div>
<div class="paragraph">
<p>Now go to the robot accounts area by clicking on the robot icon as in the next picture.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quay-installed-go-to-robot-accounts-userX.png" alt="Go to Repositories">
</div>
</div>
<div class="paragraph">
<p>Now click on the <code>Create Robot Account</code> button.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quay-installed-create-robot-account-1-userX.png" alt="Go to Repositories">
</div>
</div>
<div class="paragraph">
<p>Now please use the following data and click on the <code>Create robot Account</code> button:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name:</strong> cicd</p>
</li>
<li>
<p><strong>Description:</strong> CICD robot account</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quay-installed-create-robot-account-2-userX.png" alt="Go to Repositories">
</div>
</div>
<div class="paragraph">
<p>We have to grant permissions to our robot account, expand the <code>PERMISSIONS</code> list box and select <code>Read</code>. Then click on <code>Close</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quay-installed-create-robot-account-3-userX.png" alt="Go to Repositories">
</div>
</div>
<div class="paragraph">
<p>Well, now you have a robot account you can use to pull the image you need.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Should you need to pull another image you will have to add new permissions to your robot account.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-registry-secret"><a class="anchor" href="#create-registry-secret"></a>Create Registry Secret</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ok, so you need to make your deployment use some credentials to allow it to pull the new image&#8230;&#8203; well, let&#8217;s get started.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is not the only way to do it, you could add credentials directly to the Deployment&#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next set of commands will ask you for the <strong>username</strong> and <strong>password</strong> of the container registry account you already had or created above in this chapter or in your own registry.</p>
</div>
<div class="paragraph">
<p>If you have followed all the instructions then copy and paste the next command and run it. If you have chosen to use your own registry, change accordingly.</p>
</div>
<div class="paragraph">
<p><strong>USERNAME</strong></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export CONTAINER_REGISTRY_USERNAME="%USERNAME%+cicd"</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>TOKEN</strong></p>
</div>
<div class="paragraph">
<p>Please use the next link to open the details of your robot account.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">https://myregistry-quay-quay-system.apps.%BASE_SUBDOMAIN%/user/%USERNAME%?tab=robots</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then click on the <code>%USERNAME%-cicd</code> link, keep this link open you will have to copy the token.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quay-installed-view-credentials-robot-account-userX.png" alt="Robot Account Credentials">
</div>
</div>
<div class="paragraph">
<p>Now you have to run the following command, then go back to your browser and copy the token as in the image below.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">echo "CONTAINER_REGISTRY_PASSWORD: " &amp;&amp; read -s CONTAINER_REGISTRY_PASSWORD</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/quay-installed-copy-credentials-robot-account-userX.png" alt="Robot Account Credentials">
</div>
</div>
<div class="paragraph">
<p>Now that we have gather all the needed information let&#8217;s create the secret, named <code>street-java-pull-secret</code>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">if [ -z "${CONTAINER_REGISTRY_USERNAME}" ] &amp;&amp; [ -z "${CONTAINER_REGISTRY_PASSWORD}" ]; then
    echo "You should provide a value for CONTAINER_REGISTRY_USERNAME and CONTAINER_REGISTRY_PASSWORD"
else
oc create -n street-java-%USERNAME% secret docker-registry street-java-pull-secret \
  --docker-server=https://myregistry-quay-quay-system.apps.%BASE_SUBDOMAIN% \
  --docker-username=${CONTAINER_REGISTRY_USERNAME} \
  --docker-password=${CONTAINER_REGISTRY_PASSWORD}
fi</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="grant-pull-permissions"><a class="anchor" href="#grant-pull-permissions"></a>Granting Pull Permissions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You have created the secret with the robot account credentials, but you haven&#8217;t used that secret anywhere yet.</p>
</div>
<div class="paragraph">
<p>The idea is to update the deployment object so that our secret can be used to pull images from our registry.</p>
</div>
<div class="paragraph">
<p>In any <code>Deployment</code> object this means to add an <code>imagePullSecrets</code> array to <code>spec&#8594;template&#8594;spec</code> but instead of doing it manually we&#8217;re going to do it using a value in our helm chart as we did before with the hash of the new image. So, please open <code>helm/street-java/values.yaml</code>; you should see something like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">fruit-gateway:
  enabled: true
  image:
    repository: {quay-server}/{username}/street-java-fruit-gateway@sha256
    tag: "5b5bd615dfaf15b672a550138e6124815f823c4f424d2d30b13d26794376418f"
  imagePullSecrets: []</code></pre>
</div>
</div>
<div class="paragraph">
<p>And change it to look like this. Only change the</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">fruit-gateway:
  enabled: true
  image:
    repository: myregistry-quay-quay-system.apps.%BASE_SUBDOMAIN%/%USERNAME%/street-java-fruit-gateway@sha256
    tag: "5b5bd615dfaf15b672a550138e6124815f823c4f424d2d30b13d26794376418f"
  imagePullSecrets:
    - name: street-java-pull-secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you have to upgrade the chart.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm upgrade street-java helm/street-java</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s check everything is fine, the next command should show the secrets associated with the default service account for pulling images, our secret should be onw of them.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get deployment/fruit-gateway -o jsonpath='{.spec.template.spec.imagePullSecrets}' -n street-java-%USERNAME% | jq .</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="did-it-work"><a class="anchor" href="#did-it-work"></a>Did it Work?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Alrighty, let&#8217;s find out it our app still works properly. If you open the next link and pay attention to the <code>fruit-gateway</code> deployment.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">fruit-gateway-street-java-%USERNAME%.apps.%BASE_SUBDOMAIN%</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or run the next command:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Running the next command you will invoke <code>/api/config</code> which produces a JSON object like the next one, <code>jq .name</code> will return only the <code>name</code> attribute value, hence <code>fruit-gateway</code> in this case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "name": "fruit-gateway",
  "status": {
    "checks": [
      {
        "name": "fruit-service",
        "status": "UP"
      }
    ],
    "status": "OPERATIONAL"
  }
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -s <a href="https://$(oc" class="bare">https://$(oc</a> get route/fruit-gateway -o jsonpath='{.spec.host}')/api/config | jq .name</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also have a look to the deployment object, in this case there shouldn&#8217;t be any errors.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get deployment/fruit-gateway -n street-java-%USERNAME% -o yaml</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="05-deploy-a-new-version.html" class="query-params-link">5. Deploy New Version</a></span>
  <span class="next"><a href="07-who-needs-monitoring.html" class="query-params-link">7. Who Needs Monitoring</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
